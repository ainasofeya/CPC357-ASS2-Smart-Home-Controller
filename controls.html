<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Home - Controls</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Slider Specific Styles */
        .slider-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 40px 0;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 80px;
            height: 44px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 44px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 36px;
            width: 36px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Light Mode ON */
        input:checked + .slider {
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
        }

        /* Alarm Mode ON */
        input:checked + .slider.alarm-mode {
            background: linear-gradient(90deg, #ff416c 0%, #ff4b2b 100%);
        }

        input:checked + .slider:before {
            transform: translateX(36px);
        }

        #sliderLabel {
            margin-top: 15px;
            font-weight: bold;
            font-size: 18px;
            color: #333;
            letter-spacing: 1px;
        }
    </style>
</head>
<body>
    <div class="card">
        
        <div id="selectionMenu">
            <h2 style="text-align:left; margin-bottom:5px;">My Home</h2>
            <p style="text-align:left; color:#167661; margin-bottom:20px; font-size: 14px;">Select a system to control</p>
            
            <div class="selection-grid">
                <div class="device-tile" onclick="openControl('lights/light1', 'Main Light', 'light')">
                    <span class="icon">üí°</span>
                    <strong>Lights</strong>
                    <span class="device-count">1 Device Connected</span>
                </div>
                
                <div class="device-tile" onclick="openControl('alarm/state', 'House Alarm', 'alarm')">
                    <span class="icon">üõ°Ô∏è</span>
                    <strong>Alarm</strong>
                    <span class="device-count">System Secure</span>
                </div>
            </div>
            
            <a class="logout-link" style="margin-top:30px; display:block;" onclick="logout()">Sign Out</a>
        </div>

        <div id="controlInterface" style="display:none;">
            <h2 id="activeDeviceName" style="margin-bottom: 10px;">Device Name</h2>
            <p id="activeDeviceStatus" style="color:#888; font-size: 14px; margin-bottom: 10px;">Connecting...</p>
            
            <div class="slider-wrapper">
                <label class="switch">
                    <input type="checkbox" id="deviceSlider">
                    <span class="slider"></span>
                </label>
                <p id="sliderLabel">OFF</p>
            </div>

            <div class="status" style="margin-top: 20px;">
                <span class="status-dot" id="dot"></span> 
                Status: <strong id="statusText" style="margin-left: 5px;">---</strong>
            </div>

            <a class="back-link" onclick="showMenu()" style="display:block; margin-top:25px; cursor:pointer; color:#4facfe;">üîô Back to Control Pane</a>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyDlSQY5MM6fpllmbE5G72M1GDuUJSw8TnM", 
            databaseURL: "https://cpc357-481008-default-rtdb.asia-southeast1.firebasedatabase.app/" 
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getDatabase();

        let currentPath = "";
        let unsubscribe = null;

        // Auth Guard
        onAuthStateChanged(auth, (user) => { if (!user) window.location.href = "index.html"; });

        const deviceSlider = document.getElementById('deviceSlider');
        const sliderLabel = document.getElementById('sliderLabel');

        // Write to Firebase on Slider Change
        deviceSlider.onchange = () => {
            if (currentPath) {
                set(ref(db, currentPath), deviceSlider.checked);
            }
        };

        // UI Logic: Open Control Page
        window.openControl = (path, name, type) => {
            currentPath = path;
            document.getElementById('selectionMenu').style.display = 'none';
            document.getElementById('controlInterface').style.display = 'block';
            document.getElementById('activeDeviceName').innerText = name;

            const sliderSpan = document.querySelector('.slider');
            if(type === 'alarm') {
                sliderSpan.classList.add('alarm-mode');
            } else {
                sliderSpan.classList.remove('alarm-mode');
            }

            // Real-time Sync
            if (unsubscribe) unsubscribe(); 
            unsubscribe = onValue(ref(db, currentPath), (snapshot) => {
                const val = snapshot.val();
                deviceSlider.checked = val;
                
                // Update Labels
                sliderLabel.innerText = val ? (type === 'alarm' ? "ARMED" : "ON") : (type === 'alarm' ? "DISARMED" : "OFF");
                
                const stText = document.getElementById('statusText');
                const stDot = document.getElementById('dot');
                const stLabel = document.getElementById('activeDeviceStatus');
                
                stText.innerText = val ? "ACTIVE" : "INACTIVE";
                stLabel.innerText = val ? (type === 'alarm' ? "ALARM ARMED" : "Light is ON") : (type === 'alarm' ? "ALARM DISARMED" : "Light is OFF");
                
                // Dynamic Colors
                const activeColor = (type === 'alarm') ? "#ff416c" : "#2ecc71";
                stText.style.color = val ? activeColor : "#e74c3c";
                stDot.style.background = val ? activeColor : "#e74c3c";
                stDot.style.boxShadow = val ? `0 0 10px ${activeColor}` : "none";
            });
        };

        window.showMenu = () => {
            document.getElementById('selectionMenu').style.display = 'block';
            document.getElementById('controlInterface').style.display = 'none';
        };

        window.logout = () => { signOut(auth).then(() => window.location.href = "index.html"); };
    </script>
</body>
</html>